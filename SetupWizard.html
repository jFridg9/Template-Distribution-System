<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Setup Wizard</title>
  
  <!-- Google Drive Picker API -->
  <script src="https://apis.google.com/js/api.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .wizard-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 700px;
      width: 100%;
      overflow: hidden;
    }
    
    .wizard-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }
    
    .wizard-header h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }
    
    .progress-bar {
      display: flex;
      justify-content: space-between;
      padding: 30px 40px;
      background: #f9f9f9;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
    }
    
    .progress-step::after {
      content: '';
      position: absolute;
      top: 15px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #e0e0e0;
      z-index: 0;
    }
    
    .progress-step:last-child::after {
      display: none;
    }
    
    .progress-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e0e0e0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #999;
      position: relative;
      z-index: 1;
    }
    
    .progress-step.active .progress-circle {
      background: #667eea;
      color: white;
    }
    
    .progress-step.completed .progress-circle {
      background: #4caf50;
      color: white;
    }
    
    .progress-label {
      font-size: 0.85em;
      color: #999;
      margin-top: 8px;
    }
    
    .progress-step.active .progress-label {
      color: #667eea;
      font-weight: 600;
    }
    
    .wizard-content {
      padding: 40px;
      min-height: 400px;
    }
    
    .step {
      display: none;
    }
    
    .step.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .step h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
    }
    
    .step p {
      color: #666;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1em;
      font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .folder-picker {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .folder-info {
      padding: 12px;
      background: #f5f5f5;
      border-radius: 6px;
      margin-top: 10px;
      display: none;
    }
    
    .folder-info.active {
      display: block;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: auto;
    }
    
    .wizard-actions {
      display: flex;
      justify-content: space-between;
      padding: 30px 40px;
      background: #f9f9f9;
      border-top: 1px solid #e0e0e0;
    }
    
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn-secondary:hover {
      background: #d0d0d0;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .success-icon {
      text-align: center;
      font-size: 80px;
      margin-bottom: 20px;
    }
    
    .alert {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .alert-error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #c62828;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-left: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .feature-list {
      list-style: none;
      margin: 20px 0;
    }
    
    .feature-list li {
      padding: 12px 0;
      padding-left: 35px;
      position: relative;
    }
    
    .feature-list li::before {
      content: '‚úì';
      position: absolute;
      left: 0;
      color: #4caf50;
      font-weight: bold;
      font-size: 1.2em;
    }
    
    /* ============================================================================
     * MOBILE RESPONSIVE STYLES
     * ============================================================================
     * Optimizations for mobile devices (phones and tablets)
     * Breakpoints: 320px (small phones), 480px (phones), 768px (tablets)
     * ========================================================================== */
    
    /* Small phones (iPhone SE, etc) - 320px to 479px */
    @media (max-width: 479px) {
      body {
        padding: 10px;
      }
      
      .wizard-container {
        border-radius: 8px;
      }
      
      .wizard-header {
        padding: 25px 20px;
        position: relative;
      }
      
      .wizard-header h1 {
        font-size: 1.5em;
        margin-bottom: 8px;
      }
      
      .wizard-header p {
        font-size: 0.9em;
      }
      
      /* Move Set Public URL button to better position */
      .wizard-header > div[style*="position:absolute"] {
        position: relative !important;
        right: auto !important;
        top: auto !important;
        margin-top: 15px;
      }
      
      .wizard-header > div[style*="position:absolute"] .btn {
        width: 100%;
        padding: 10px;
        font-size: 0.9em;
      }
      
      /* Optimize progress bar for mobile */
      .progress-bar {
        padding: 20px 10px;
        overflow-x: auto;
      }
      
      .progress-step {
        min-width: 70px;
      }
      
      .progress-circle {
        width: 28px;
        height: 28px;
        font-size: 0.9em;
      }
      
      .progress-label {
        font-size: 0.75em;
        margin-top: 6px;
      }
      
      /* Content area adjustments */
      .wizard-content {
        padding: 25px 20px;
        min-height: 300px;
      }
      
      .step h2 {
        font-size: 1.3em;
        margin-bottom: 15px;
      }
      
      .step p {
        font-size: 0.95em;
        margin-bottom: 15px;
      }
      
      /* Form optimizations */
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-group input,
      .form-group textarea {
        font-size: 16px; /* Prevents zoom on iOS */
        min-height: 44px;
        padding: 10px;
      }
      
      .folder-picker {
        flex-direction: column;
        align-items: stretch;
      }
      
      .folder-picker input {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .folder-picker .btn {
        width: 100%;
      }
      
      /* Touch-friendly buttons */
      .btn {
        min-height: 44px;
        padding: 12px 20px;
        font-size: 0.95em;
      }
      
      /* Action buttons */
      .wizard-actions {
        padding: 20px 15px;
        flex-direction: column;
        gap: 10px;
      }
      
      .wizard-actions .btn {
        width: 100%;
        order: 2;
      }
      
      #backBtn {
        order: 1;
      }
      
      /* Feature list adjustments */
      .feature-list {
        margin: 15px 0;
      }
      
      .feature-list li {
        padding: 10px 0 10px 30px;
        font-size: 0.95em;
      }
      
      .feature-list li::before {
        font-size: 1em;
      }
      
      /* Success icon */
      .success-icon {
        font-size: 60px;
        margin-bottom: 15px;
      }
    }
    
    /* Phones in portrait - 480px to 767px */
    @media (min-width: 480px) and (max-width: 767px) {
      body {
        padding: 15px;
      }
      
      .wizard-header {
        padding: 30px 25px;
      }
      
      .wizard-header h1 {
        font-size: 1.8em;
      }
      
      .wizard-content {
        padding: 30px 25px;
      }
      
      .step h2 {
        font-size: 1.4em;
      }
      
      /* Form inputs */
      .form-group input,
      .form-group textarea {
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      .btn {
        min-height: 44px;
      }
      
      /* Keep horizontal button layout on larger phones */
      .wizard-actions {
        padding: 25px 20px;
      }
    }
    
    /* Tablets - 768px to 1023px */
    @media (min-width: 768px) and (max-width: 1023px) {
      .wizard-container {
        max-width: 90%;
      }
      
      .wizard-content {
        padding: 35px;
      }
      
      .btn {
        min-height: 44px;
      }
    }
    
    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      /* Increase touch targets */
      .btn {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Remove hover effects on touch devices */
      .btn-primary:hover {
        background: #667eea;
      }
      
      .btn-secondary:hover {
        background: #e0e0e0;
      }
      
      /* Add active state for touch feedback */
      .btn:active {
        opacity: 0.8;
        transform: scale(0.98);
      }
      
      .progress-circle {
        transition: transform 0.2s;
      }
      
      .progress-step.active .progress-circle {
        transform: scale(1.1);
      }
    }
    
    /* Landscape orientation handling */
    @media (max-width: 767px) and (orientation: landscape) {
      .wizard-header {
        padding: 20px;
      }
      
      .wizard-header h1 {
        font-size: 1.4em;
      }
      
      .wizard-content {
        padding: 20px;
        min-height: 250px;
      }
      
      .progress-bar {
        padding: 15px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="wizard-container">
    <div class="wizard-header">
      <h1>üöÄ Setup Wizard</h1>
      <p>Let's get your Template Distribution System configured</p>
      <div style="position:absolute; right:18px; top:18px;">
        <button class="btn btn-secondary" onclick="configurePublicUrl()" title="Set canonical public webapp URL">‚öôÔ∏è Set Public URL</button>
      </div>
    </div>
    
    <div class="progress-bar">
      <div class="progress-step active" data-step="1">
        <div class="progress-circle">1</div>
        <div class="progress-label">Welcome</div>
      </div>
      <div class="progress-step" data-step="2">
        <div class="progress-circle">2</div>
        <div class="progress-label">Configuration</div>
      </div>
      <div class="progress-step" data-step="3">
        <div class="progress-circle">3</div>
        <div class="progress-label">First Product</div>
      </div>
      <div class="progress-step" data-step="4">
        <div class="progress-circle">4</div>
        <div class="progress-label">Complete</div>
      </div>
    </div>
    
    <div class="wizard-content">
      <div id="alertContainer"></div>
      
      <!-- Step 1: Welcome -->
      <div class="step active" data-step="1">
        <h2>Welcome to Template Distribution System</h2>
        <p>This wizard will help you set up your system in just a few steps. <strong>Everything is automated</strong> - no manual configuration needed!</p>
        
        <ul class="feature-list">
          <li><strong>Auto-Create Configuration:</strong> We'll create and link your configuration sheet automatically</li>
          <li><strong>Visual Folder Selection:</strong> Use Drive Picker to select folders - no copying IDs</li>
          <li><strong>Add Your First Product:</strong> Configure your first template through a user-friendly interface</li>
          <li><strong>Zero Code Changes:</strong> All configuration is managed through the web interface</li>
        </ul>
        
        <p>You'll need:</p>
        <ul class="feature-list">
          <li>A Google Drive folder containing your template files (Google Sheets)</li>
          <li>About 5 minutes to complete the setup</li>
        </ul>
      </div>
      
      <!-- Step 2: Create Config Sheet -->
      <div class="step" data-step="2">
        <h2>Create Configuration Sheet</h2>
        <p>We'll create a Google Sheet to store your product configurations and automatically link it to the system. No manual ID copying needed!</p>
        
        <div id="configStatus">
          <p>Click "Create Configuration Sheet" to get started.</p>
        </div>
      </div>
      
      <!-- Step 3: Add First Product -->
      <div class="step" data-step="3">
        <h2>Add Your First Product</h2>
        <p>Let's add your first template product. This will appear on your landing page.</p>
        
        <form id="productForm">
          <div class="form-group">
            <label for="productName">Product Name (Internal ID)*</label>
            <input type="text" id="productName" required 
                   pattern="[A-Za-z0-9_-]+" 
                   title="Only letters, numbers, hyphens and underscores"
                   placeholder="e.g., EventPlanning">
            <small>Used in URLs. No spaces allowed.</small>
          </div>
          
          <div class="form-group">
            <label for="displayName">Display Name*</label>
            <input type="text" id="displayName" required
                   placeholder="e.g., Event Planning Tool">
            <small>User-facing name shown on landing page</small>
          </div>
          
          <div class="form-group">
            <label for="folderId">Google Drive Folder*</label>
            <div class="folder-picker">
              <input type="text" id="folderId" required placeholder="Click 'Browse File' to select a template file">
              <button type="button" class="btn btn-secondary" onclick="openDrivePicker()">
                ÔøΩ Browse File
              </button>
            </div>
            <small style="color: #666; display: block; margin-top: 6px;">
              Select any template file from your Drive. We'll automatically use its parent folder to find all versions.
            </small>
            <div id="folderInfo" class="folder-info"></div>
          </div>
          
          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" placeholder="Brief description for landing page (optional)"></textarea>
          </div>
          
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="enabled" checked>
              <label for="enabled">Enable this product immediately</label>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button type="button" class="btn btn-secondary" onclick="copyProductLink(document.getElementById('productName').value)">
              üîó Copy Link
            </button>
          </div>
        </form>
      </div>
      
      <!-- Step 4: Complete -->
      <div class="step" data-step="4">
        <div class="success-icon">üéâ</div>
        <h2>Setup Complete!</h2>
        <p>Your Template Distribution System is now configured and ready to use.</p>
        
        <ul class="feature-list">
          <li>Configuration sheet created and linked</li>
          <li>First product added successfully</li>
          <li>System is live and accessible</li>
        </ul>
        
        <p><strong>Next steps:</strong></p>
        <ul class="feature-list">
          <li>Visit the admin panel to manage products</li>
          <li>View the landing page to see your product</li>
          <li>Share your product URLs with users</li>
        </ul>
      </div>
    </div>
    
    <div class="wizard-actions">
      <button id="backBtn" class="btn btn-secondary" onclick="previousStep()" disabled>
        ‚Üê Back
      </button>
      <button id="nextBtn" class="btn btn-primary" onclick="nextStep()">
        Next ‚Üí
      </button>
    </div>
  </div>
  
  <script>
  let currentStep = 1;
  const totalSteps = 4;
  let configCreated = false;

  // Verbose UI logging helper (mirror of AdminPanel)
  const UI_DEBUG = true;
  function uiLog(...args) { if (!UI_DEBUG) return; try { console.log(new Date().toISOString(), ...args); } catch (e) {} }
  function runServerCall(functionName, args, label, handlers) {
    args = args || [];
    label = label || functionName;
    handlers = handlers || {};
    const start = Date.now();
    uiLog(`[${label}] -> request`, { functionName, args });

    const caller = google.script.run
      .withSuccessHandler(function(result) {
        const duration = Date.now() - start;
        uiLog(`[${label}] <- success`, { durationMs: duration, result });
        if (handlers.success) try { handlers.success(result); } catch (e) { uiLog(`[${label}] success handler error`, e); }
      })
      .withFailureHandler(function(error) {
        const duration = Date.now() - start;
        uiLog(`[${label}] <- failure`, { durationMs: duration, error });
        if (handlers.failure) try { handlers.failure(error); } catch (e) { uiLog(`[${label}] failure handler error`, e); }
      });

    try { caller[functionName].apply(caller, args); } catch (err) { uiLog(`[${label}] call error`, err); if (handlers.failure) handlers.failure(err); }
  }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadGooglePicker();
      updateButtons();
    });
    
    // Navigation
    function nextStep() {
      if (currentStep === 2 && !configCreated) {
        createConfigSheet();
        return;
      }
      
      if (currentStep === 3) {
        saveFirstProduct();
        return;
      }
      
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
      } else {
        // Go to admin panel
        window.location.href = '?admin=true';
      }
    }
    
    function previousStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
      }
    }
    
    function showStep(step) {
      // Update steps
      document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
      document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
      
      // Update progress
      document.querySelectorAll('.progress-step').forEach(el => {
        const stepNum = parseInt(el.dataset.step);
        el.classList.remove('active', 'completed');
        if (stepNum === step) {
          el.classList.add('active');
        } else if (stepNum < step) {
          el.classList.add('completed');
        }
      });
      
      updateButtons();
    }
    
    function updateButtons() {
      const backBtn = document.getElementById('backBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      backBtn.disabled = currentStep === 1;
      
      if (currentStep === 2) {
        nextBtn.textContent = configCreated ? 'Next ‚Üí' : 'Create Configuration Sheet';
      } else if (currentStep === 3) {
        nextBtn.textContent = 'Add Product';
      } else if (currentStep === 4) {
        nextBtn.textContent = 'Go to Admin Panel ‚Üí';
      } else {
        nextBtn.textContent = 'Next ‚Üí';
      }
    }
    
    // Create config sheet
    function createConfigSheet() {
      const statusDiv = document.getElementById('configStatus');
      statusDiv.innerHTML = '<p>Creating configuration sheet... <span class="loading"></span></p>';
      
      runServerCall('setupCreateConfigSheet', [], 'createConfigSheet', {
        success: function(result) {
          if (result.success) {
            configCreated = true;
            statusDiv.innerHTML = `
              <div style="padding: 20px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                <h3 style="color: #2e7d32; margin-bottom: 10px;">‚úÖ Configuration Sheet Created</h3>
                <p style="margin-bottom: 10px;">Sheet ID: <code style="background: white; padding: 2px 6px; border-radius: 3px;">${result.sheetId}</code></p>
                <p style="margin-bottom: 10px;"><strong>‚úì Configuration automatically saved</strong> - No code changes needed!</p>
                <p><a href="https://docs.google.com/spreadsheets/d/${result.sheetId}/edit" target="_blank" style="color: #2e7d32;">Open Configuration Sheet ‚Üí</a></p>
              </div>
            `;
            updateButtons();
            showAlert('Configuration sheet created and linked automatically!', 'success');
          } else {
            statusDiv.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
          }
        },
        failure: function(error) {
          statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error && error.message ? error.message : error}</div>`;
        }
      });
    }
    
    // Save first product
    function saveFirstProduct() {
      const form = document.getElementById('productForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const productData = {
        name: document.getElementById('productName').value,
        displayName: document.getElementById('displayName').value,
        folderId: document.getElementById('folderId').value,
        description: document.getElementById('description').value,
        enabled: document.getElementById('enabled').checked
      };
      
      const nextBtn = document.getElementById('nextBtn');
      nextBtn.disabled = true;
      nextBtn.innerHTML = 'Adding Product... <span class="loading"></span>';
      
      runServerCall('addProduct', [productData], 'addProduct', {
        success: function(result) {
          nextBtn.disabled = false;
          nextBtn.textContent = 'Add Product';

          if (result.success) {
            showAlert('Product added successfully!', 'success');
            currentStep++;
            showStep(currentStep);
          } else {
            showAlert('Error: ' + result.error, 'error');
          }
        },
        failure: function(error) {
          nextBtn.disabled = false;
          nextBtn.textContent = 'Add Product';
          showAlert('Error: ' + (error && error.message ? error.message : error), 'error');
        }
      });
    }
    
    // Validate folder
    function validateFolder(folderId) {
      const folderInfo = document.getElementById('folderInfo');
      folderInfo.innerHTML = '<div class="loading"></div> Checking folder...';
      folderInfo.classList.add('active');
      
      runServerCall('getFolderDetails', [folderId], 'validateFolder', {
        success: function(result) {
          if (result.success) {
            folderInfo.innerHTML = `
              ‚úÖ <strong>${result.name}</strong><br>
              üìä Contains ${result.fileCount} Google Sheets file(s)
            `;
          } else {
            folderInfo.innerHTML = `‚ùå ${result.error}`;
          }
        },
        failure: function(error) {
          folderInfo.innerHTML = `‚ùå ${error && error.message ? error.message : error}`;
        }
      });
    }
    
    // Google Drive Picker
    let pickerApiLoaded = false;
    let oauthToken = null;
    let developerKey = null;
    let pickerAppId = null;

    function loadGooglePicker() {
      gapi.load('picker', function() {
        pickerApiLoaded = true;
      });
      
      runServerCall('getOAuthToken', [], 'getOAuthToken', {
        success: function(token) { oauthToken = token; uiLog('oauthToken retrieved', { hasToken: !!token }); },
        failure: function(error) { uiLog('getOAuthToken failed', error); }
      });

      // Fetch the Google Picker API key from Script Properties
      runServerCall('getPickerApiKey', [], 'getPickerApiKey', {
        success: function(key) {
          developerKey = key;
          if (!developerKey) {
            console.warn('Google Picker API key not set. Add PICKER_API_KEY in Script Properties.');
          }
          uiLog('Picker key fetched', { keyPrefix: developerKey ? developerKey.substring(0,6) : null, keyLength: developerKey ? developerKey.length : 0 });
        },
        failure: function(error) { uiLog('getPickerApiKey failed', error); }
      });

      // Fetch optional Picker App ID (numeric GCP project number)
      runServerCall('getPickerAppId', [], 'getPickerAppId', {
        success: function(id) { pickerAppId = id; if (pickerAppId) uiLog('Picker App ID:', pickerAppId); },
        failure: function(error) { uiLog('getPickerAppId failed', error); }
      });
    }

    /**
     * Opens the Google Picker to select a template FILE.
     * We'll extract the parent folder server-side for reliable folder detection.
     */
    function openDrivePicker() {
      uiLog('openDrivePicker called', { pickerApiLoaded: pickerApiLoaded, hasToken: !!oauthToken });
      if (!pickerApiLoaded || !oauthToken) {
        alert('Drive Picker is loading... please try again in a moment.');
        return;
      }

      if (!developerKey) {
        alert('Google Picker is not configured. Ask the admin to set PICKER_API_KEY in Script Properties (Apps Script ‚Üí Project Settings).');
        return;
      }
      
      const origin = (google && google.script && google.script.host && google.script.host.origin)
        ? google.script.host.origin
        : window.location.origin;

      console.log('Picker diagnostics on open:', {
        pickerApiLoaded,
        hasToken: !!oauthToken,
        origin
      });

  // Create standard views for file selection (most reliable approach)
  // No MIME type filter - allow any file type (templates can be Sheets, Docs, Slides, PDFs, etc.)
  
  // Recent view
  const recentView = new google.picker.DocsView(google.picker.ViewId.RECENTLY_PICKED);

  // My Drive with tree navigation (no setIncludeFolders - that makes it flat!)
  const driveView = new google.picker.DocsView(google.picker.ViewId.DOCS);

  // Shared Drives view
  const sharedDriveView = new google.picker.DocsView(google.picker.ViewId.DOCS)
    .setEnableDrives(true);

  // Build the Picker
  const builder = new google.picker.PickerBuilder()
    .setTitle('Select a Template File')
    .setOAuthToken(oauthToken)
    .setDeveloperKey(developerKey)
    .setOrigin(origin)
    .setCallback(pickerCallback)
    .addView(recentView)
    .addView(driveView)
    .addView(sharedDriveView)
    .enableFeature(google.picker.Feature.SUPPORT_DRIVES);

      if (pickerAppId) {
        try {
          builder.setAppId(pickerAppId);
        } catch (err) {
          console.warn('Failed to set Picker App ID:', err && err.message);
        }
      }

      const picker = builder.build();
      picker.setVisible(true);
    }
    
    function pickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const file = data.docs[0];
        uiLog('pickerCallback: file selected', { fileId: file.id, fileName: file.name });
        
        // Show loading state
        const folderInfo = document.getElementById('folderInfo');
        folderInfo.innerHTML = '<div class="loading"></div> Getting parent folder...';
        folderInfo.classList.add('active');
        
        // Call server to get parent folder from file ID
        runServerCall('getParentFolderFromFile', [file.id], 'getParentFolder', {
          success: function(result) {
            if (result.success) {
              document.getElementById('folderId').value = result.folderId;
              folderInfo.innerHTML = `
                ‚úÖ <strong>${result.folderName}</strong><br>
                üìä Contains ${result.fileCount} file(s)<br>
                <small style="color: #666;">Selected from: ${file.name}</small>
              `;
            } else {
              folderInfo.innerHTML = `‚ùå ${result.error}`;
            }
          },
          failure: function(error) {
            folderInfo.innerHTML = `‚ùå ${error && error.message ? error.message : error}`;
          }
        });
      }
    }

    // Public URL helpers (same behavior as AdminPanel)
    function detectBaseFromLocation() {
      try {
        const href = window.location.href;
        const execIndex = href.indexOf('/exec');
        const devIndex = href.indexOf('/dev');
        if (execIndex !== -1) return href.substring(0, execIndex) + '/exec';
        if (devIndex !== -1) return href.substring(0, devIndex) + '/dev';
        return (window.location.origin + window.location.pathname).replace(/\/$/, '');
      } catch (e) {
        uiLog('detectBaseFromLocation failed', e && e.message);
        return window.location.origin;
      }
    }

    function copyProductLink(productName) {
      if (!productName) {
        alert('Please fill the Product Name field first');
        return;
      }
      uiLog('copyProductLink (setup)', { productName });
      runServerCall('getPublicWebAppUrl', [], 'getPublicWebAppUrl', {
        success: function(override) {
          const base = override && override.length ? override : detectBaseFromLocation();
          let url = base;
          if (!url.endsWith('/exec') && !url.endsWith('/dev') && !url.endsWith('/')) url += '/';
          url += '?product=' + encodeURIComponent(productName);
          copyToClipboard(url).then(function() {
            showAlert('Product link copied to clipboard', 'success');
          }).catch(function() { prompt('Copy the product link below', url); });
        },
        failure: function(err) {
          uiLog('getPublicWebAppUrl failed (setup)', err);
          const base = detectBaseFromLocation();
          let url = base;
          if (!url.endsWith('/exec') && !url.endsWith('/dev') && !url.endsWith('/')) url += '/';
          url += '?product=' + encodeURIComponent(productName);
          copyToClipboard(url).then(function() { showAlert('Product link copied to clipboard', 'success'); }).catch(function() { prompt('Copy the product link below', url); });
        }
      });
    }

    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise(function(resolve, reject) {
        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          resolve();
        } catch (e) { reject(e); }
      });
    }

    function configurePublicUrl() {
      runServerCall('getPublicWebAppUrl', [], 'getPublicWebAppUrl', {
        success: function(current) {
          const hint = current && current.length ? current : detectBaseFromLocation();
          const val = prompt('Set the canonical public web app URL (leave blank to clear):', hint);
          if (val === null) return;
          // Validate before saving
          runServerCall('validatePublicWebAppUrl', [val || ''], 'validatePublicWebAppUrl', {
            success: function(validation) {
              if (validation && validation.success) {
                runServerCall('setPublicWebAppUrl', [val || ''], 'setPublicWebAppUrl', { success: function(res) { if (res && res.success) showAlert('Public URL saved and verified', 'success'); else showAlert('Saved but could not verify', 'error'); }, failure: function(err) { showAlert('Error saving public URL: ' + (err && err.message ? err.message : err), 'error'); } });
              } else {
                const msg = (validation && validation.warning) ? validation.warning : (validation && validation.error ? validation.error : 'Validation failed');
                if (confirm(msg + '\n\nSave this URL anyway?')) {
                  runServerCall('setPublicWebAppUrl', [val || ''], 'setPublicWebAppUrl', { success: function(res) { if (res && res.success) showAlert(res.message, 'success'); else showAlert('Error saving public URL', 'error'); }, failure: function(err) { showAlert('Error: ' + (err && err.message ? err.message : err), 'error'); } });
                } else { showAlert('Public URL not saved', 'info'); }
              }
            },
            failure: function(err) { showAlert('Validation error: ' + (err && err.message ? err.message : err), 'error'); }
          });
        },
        failure: function(err) {
          uiLog('getPublicWebAppUrl failed (setup)', err);
          const val = prompt('Set the canonical public web app URL (leave blank to clear):', detectBaseFromLocation());
          if (val === null) return;
          runServerCall('validatePublicWebAppUrl', [val || ''], 'validatePublicWebAppUrl', {
            success: function(validation) {
              if (validation && validation.success) {
                runServerCall('setPublicWebAppUrl', [val || ''], 'setPublicWebAppUrl', { success: function(res) { if (res && res.success) showAlert('Public URL saved and verified', 'success'); else showAlert('Saved but could not verify', 'error'); }, failure: function(err) { showAlert('Error saving public URL: ' + (err && err.message ? err.message : err), 'error'); } });
              } else {
                const msg = (validation && validation.warning) ? validation.warning : (validation && validation.error ? validation.error : 'Validation failed');
                if (confirm(msg + '\n\nSave this URL anyway?')) {
                  runServerCall('setPublicWebAppUrl', [val || ''], 'setPublicWebAppUrl', { success: function(res) { if (res && res.success) showAlert(res.message, 'success'); else showAlert('Error saving public URL', 'error'); }, failure: function(err) { showAlert('Error: ' + (err && err.message ? err.message : err), 'error'); } });
                } else { showAlert('Public URL not saved', 'info'); }
              }
            },
            failure: function(err) { showAlert('Validation error: ' + (err && err.message ? err.message : err), 'error'); }
          });
        }
      });
    }
    
    // Alert helper
    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `
        <div class="alert alert-${type === 'error' ? 'error' : 'success'}">
          ${message}
        </div>
      `;
      
      setTimeout(function() {
        container.innerHTML = '';
      }, 5000);
    }
  </script>
</body>
</html>

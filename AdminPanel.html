<!DOCTYPE html>
<html>
        <tr>
          <td data-label="Product Name"><strong>${product.name}</strong></td>
          <td data-label="Display Name">${product.displayName}</td>
          <td data-label="Category"><span style="padding: 4px 8px; background: #667eea; color: white; border-radius: 4px; font-size: 0.85em;">${product.category || 'Uncategorized'}</span></td>
          <td data-label="Status">
        <tr>
          <td>
            <input type="checkbox" class="product-checkbox" data-product="${product.name}" onchange="updateSelection('${product.name}', this.checked)">
          </td>
          <td data-label="Product Name"><strong>${product.name}</strong></td>
          <td data-label="Display Name">${product.displayName}</td>
          <td data-label="Category"><span style="padding: 4px 8px; background: #667eea; color: white; border-radius: 4px; font-size: 0.85em;">${product.category || 'Uncategorized'}</span></td>
          <td data-label="Status"><span class="status-badge ${product.enabled ? 'status-enabled' : 'status-disabled'}">${product.enabled ? 'Enabled' : 'Disabled'}</span></td>
      padding: 30px;
    }
    
    header h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }
    
    header p {
      opacity: 0.9;
    }
    
    .content {
      padding: 30px;
    }
    
    .actions {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn-secondary:hover {
      background: #d0d0d0;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn-danger:hover {
      background: #da190b;
    }
    
    .products-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .products-table th,
    .products-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .products-table th {
      background: #f5f5f5;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      font-size: 0.85em;
    }
    
    .products-table tr:hover {
      background: #f9f9f9;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
    }
    
    .status-enabled {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .status-disabled {
      background: #ffebee;
      color: #c62828;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: #667eea;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1em;
      font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: auto;
    }
    
    .folder-picker {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .folder-info {
      padding: 12px;
      background: #f5f5f5;
      border-radius: 6px;
      margin-top: 10px;
      display: none;
    }
    
    .folder-info.active {
      display: block;
    }
    
    .alert {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #2e7d32;
    }
    
    .alert-error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #c62828;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }
    
    .toast {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
      border-left: 4px solid #666;
    }
    
    .toast.success { border-left-color: #4caf50; }
    .toast.error { border-left-color: #f44336; }
    .toast.warning { border-left-color: #ff9800; }
    .toast.info { border-left-color: #2196f3; }
    
    .toast-icon { font-size: 24px; flex-shrink: 0; }
    .toast-content { flex: 1; }
    .toast-title { font-weight: 600; margin-bottom: 4px; color: #333; }
    .toast-message { color: #666; font-size: 0.9em; }
    
    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .toast-close:hover { color: #333; }
    
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
    
    .toast.hiding { animation: slideOut 0.3s ease-out forwards; }
    
    /* Loading overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    
    .loading-overlay.active { display: flex; }
    
    .loading-spinner {
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    .loading-spinner .loading {
      width: 40px;
      height: 40px;
      margin-bottom: 15px;
    }
    
    .loading-text { color: #666; font-weight: 600; }
 
    /* Tab Navigation */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 0;
    }
    
    .tab {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: #666;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .tab:hover {
      color: #667eea;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Analytics Styles */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .analytics-card {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
    }
    
    .analytics-card h3 {
      font-size: 0.9em;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 10px;
    }
    
    .analytics-card .value {
      font-size: 2.5em;
      font-weight: bold;
      color: #667eea;
    }
    
    .analytics-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .analytics-table th,
    .analytics-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .analytics-table th {
      background: #f5f5f5;
      font-weight: 600;
      color: #666;
      font-size: 0.9em;
    }
    
    .analytics-table tr:hover {
      background: #f9f9f9;
    }
    
    .progress-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }
    
    .filter-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: end;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
      font-size: 0.9em;
    }
    
    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1em;
    }

    /* Bulk Operations Styles */
    .bulk-actions-bar {
      display: none;
      padding: 15px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      margin-bottom: 20px;
      border-radius: 6px;
      align-items: center;
      gap: 15px;
    }
    
    .bulk-actions-bar.active {
      display: flex;
    }
    
    .bulk-actions-bar select {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1em;
    }
    
    .import-export-section {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 0.9em;
    }
    
    .preview-table th,
    .preview-table td {
      padding: 10px;
      text-align: left;
      border: 1px solid #e0e0e0;
    }
    
    .preview-table th {
      background: #f5f5f5;
      font-weight: 600;
    }
    
    .preview-new {
      background: #e8f5e9;
    }
    
    .preview-update {
      background: #fff3e0;
    }
    
    .summary-box {
      padding: 15px;
      background: #f5f5f5;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .summary-box h3 {
      margin-bottom: 10px;
      color: #667eea;
    }
    
    .warning-list {
      margin: 15px 0;
      padding: 15px;
      background: #fff3cd;
      border-radius: 6px;
    }
    
    .warning-list ul {
      margin: 10px 0 0 20px;
    }
    /* ============================================================================
     * MOBILE RESPONSIVE STYLES
     * ============================================================================
     * Optimizations for mobile devices (phones and tablets)
     * Includes responsive design for tabs, analytics, and product management
     * Breakpoints: 320px (small phones), 480px (phones), 768px (tablets)
     * ========================================================================== */
    
    /* All phones - shared styles (320px to 767px) */
    @media (max-width: 767px) {
      /* Convert table to card layout on all phones */
      .products-table,
      .analytics-table {
        display: block;
      }
      
      .products-table thead,
      .analytics-table thead {
        display: none;
      }
      
      .products-table tbody,
      .analytics-table tbody {
        display: block;
      }
      
      .products-table tr,
      .analytics-table tr {
        display: block;
        margin-bottom: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        background: white;
      }
      
      .products-table td,
      .analytics-table td {
        display: block;
        text-align: left;
        border: none;
        padding: 8px 0;
      }
      
      .products-table td::before,
      .analytics-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #666;
        display: block;
        margin-bottom: 4px;
        font-size: 0.85em;
        text-transform: uppercase;
      }
      
      /* Touch-friendly buttons */
      .btn {
        min-height: 44px;
      }
      
      .form-group input,
      .form-group textarea {
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      /* Tabs optimization for mobile */
      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }
      
      .tab {
        white-space: nowrap;
        min-height: 44px;
        padding: 12px 20px;
      }
      
      /* Analytics grid stacks on mobile */
      .analytics-grid {
        grid-template-columns: 1fr;
      }
      
      /* Filter controls stack on mobile */
      .filter-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-group {
        width: 100%;
        min-width: unset;
      }
    }
    
    /* Small phones (iPhone SE, etc) - 320px to 479px */
    @media (max-width: 479px) {
      body {
        padding: 10px;
      }
      
      .container {
        border-radius: 0;
        box-shadow: none;
      }
      
      header {
        padding: 20px 15px;
      }
      
      header h1 {
        font-size: 1.5em;
      }
      
      header p {
        font-size: 0.9em;
      }
      
      .content {
        padding: 15px;
      }
      
      /* Stack action buttons vertically on very small screens */
      .actions {
        flex-direction: column;
        gap: 10px;
      }
      
      .actions .btn {
        width: 100%;
        text-align: center;
      }
      
      .btn {
        padding: 14px 20px;
        font-size: 0.95em;
      }
      
      /* Stack action buttons in table rows */
      .products-table td button,
      .analytics-table td button {
        display: block;
        width: 100%;
        margin: 5px 0;
        min-height: 44px;
      }
      
      /* Modal optimizations for mobile */
      .modal-content {
        width: 100%;
        max-width: 100%;
        max-height: 95vh;
        padding: 20px 15px;
        border-radius: 8px 8px 0 0;
        margin: auto auto 0 auto;
      }
      
      .modal-header h2 {
        font-size: 1.3em;
      }
      
      .form-group input,
      .form-group textarea {
        min-height: 44px;
      }
      
      .folder-picker {
        flex-direction: column;
        align-items: stretch;
      }
      
      .folder-picker input {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .folder-picker .btn {
        width: 100%;
      }
      
      /* Analytics cards full width */
      .analytics-card .value {
        font-size: 2em;
      }
      
      /* Tab text smaller on very small screens */
      .tab {
        font-size: 0.9em;
        padding: 10px 16px;
      }
    }
    
    /* Phones in portrait - 480px to 767px */
    @media (min-width: 480px) and (max-width: 767px) {
      body {
        padding: 15px;
      }
      
      header {
        padding: 25px 20px;
      }
      
      header h1 {
        font-size: 1.8em;
      }
      
      .content {
        padding: 20px;
      }
      
      /* Wrap action buttons but keep some on same line */
      .actions {
        gap: 12px;
      }
      
      .btn {
        padding: 12px 20px;
      }
      
      /* Horizontal button layout for actions in cards */
      .products-table td button,
      .analytics-table td button {
        display: inline-block;
        width: auto;
        margin: 5px 5px 5px 0;
        min-height: 44px;
      }
      
      .modal-content {
        width: 95%;
        padding: 25px 20px;
      }
    }
    
    /* Tablets - 768px to 1023px */
    @media (min-width: 768px) and (max-width: 1023px) {
      .container {
        max-width: 100%;
      }
      
      header {
        padding: 30px 25px;
      }
      
      .content {
        padding: 25px;
      }
      
      /* Keep table but optimize spacing */
      .products-table th,
      .products-table td,
      .analytics-table th,
      .analytics-table td {
        padding: 12px 10px;
        font-size: 0.95em;
      }
      
      /* Ensure buttons are touch-friendly */
      .btn {
        min-height: 44px;
      }
      
      .products-table td button,
      .analytics-table td button {
        padding: 8px 12px;
        font-size: 0.85em;
        min-height: 44px;
      }
      
      .modal-content {
        width: 90%;
        max-width: 600px;
      }
      
      /* Analytics grid adapts to tablet */
      .analytics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Touch device optimizations (all mobile devices) */
    @media (hover: none) and (pointer: coarse) {
      /* Increase touch targets */
      .btn {
        min-height: 44px;
        min-width: 44px;
      }
      
      .tab {
        min-height: 44px;
      }
      
      /* Remove hover effects on touch devices */
      .btn-primary:hover {
        background: #667eea;
      }
      
      .btn-secondary:hover {
        background: #e0e0e0;
      }
      
      .btn-danger:hover {
        background: #f44336;
      }
      
      .products-table tr:hover,
      .analytics-table tr:hover {
        background: white;
      }
      
      .tab:hover {
        color: #666;
      }
      
      .product-card:hover {
        transform: none;
      }
      
      /* Add active state for touch feedback */
      .btn:active {
        opacity: 0.8;
        transform: scale(0.98);
      }
      
      .tab:active {
        opacity: 0.7;
      }
    }
    
    /* Landscape orientation handling */
    @media (max-width: 767px) and (orientation: landscape) {
      header {
        padding: 15px 20px;
      }
      
      header h1 {
        font-size: 1.4em;
      }
      
      .modal-content {
        max-height: 90vh;
        overflow-y: auto;
      }
      
      .tabs {
        padding-bottom: 5px;
      }
    }
 
 
  </style>
</head>
<body>
  <!-- Toast notification container -->
  <div id="toastContainer" class="toast-container"></div>
  
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
      <div class="loading"></div>
      <div class="loading-text" id="loadingText">Loading...</div>
    </div>
  </div>
  
  <div class="container">
    <header>
      <h1>üõ†Ô∏è Admin Panel</h1>
      <p>Template Distribution System - Product Management</p>
    </header>
    <!-- Editor-preview warning banner (hidden by default) -->
    <div id="editorBanner" style="display:none;padding:12px;background:#fff3cd;border-left:4px solid #ffecb5;color:#664d03;">
      You are viewing the admin panel inside the Apps Script editor preview. Some features (Picker) may be blocked by iframe restrictions. 
      <button class="btn btn-secondary" style="margin-left:12px;" id="openTopBtn">Open in new tab</button>
    </div>
    
    <div class="content">
      <div id="alertContainer"></div>
      
      <!-- Tab Navigation -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('products', this)">
          üì¶ Products
        </button>
        <button class="tab" onclick="switchTab('analytics', this)">
          üìä Analytics
        </button>
      </div>
      
      <!-- Products Tab -->
      <div id="productsTab" class="tab-content active">
        <div class="actions">
          <button class="btn btn-primary" onclick="openAddProductModal()">
            ‚ûï Add New Product
          </button>
          <button class="btn btn-secondary" onclick="refreshProducts()">
            üîÑ Refresh
          </button>
          <button class="btn btn-secondary" onclick="clearCache()">
            üóëÔ∏è Clear Cache
          </button>
          <button class="btn btn-secondary" onclick="window.location.href = detectBaseFromLocation()">
            üè† View Landing Page
          </button>
          <button class="btn btn-secondary" onclick="configurePublicUrl()">
            ‚öôÔ∏è Set Public URL
          </button>

          <div class="import-export-section">
            <button class="btn btn-secondary" onclick="exportToCSV()">
              üì• Export CSV
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('csvFileInput').click()">
              üì§ Import CSV
            </button>
            <input type="file" id="csvFileInput" accept=".csv" onchange="handleCSVUpload(event)">
            <button class="btn btn-secondary" onclick="downloadCSVTemplate()">
              üìã CSV Template
            </button>
          </div>
        </div>
        
        <!-- Bulk Actions Bar -->
        <div id="bulkActionsBar" class="bulk-actions-bar">
          <span id="selectedCount">0 products selected</span>
          <select id="bulkActionSelect">
            <option value="">-- Select Action --</option>
            <option value="enable">Enable Selected</option>
            <option value="disable">Disable Selected</option>
            <option value="delete">Delete Selected</option>
          </select>
          <button class="btn btn-primary" onclick="executeBulkAction()">
            Apply
          </button>
          <button class="btn btn-secondary" onclick="clearSelection()">
            Clear Selection
          </button>
        </div>
        
        <div id="productsContainer">
          <? if (products.length === 0) { ?>
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
              </svg>
              <h2>No Products Yet</h2>
              <p>Click "Add New Product" to get started</p>
            </div>
          <? } else { ?>
            <table class="products-table">
              <thead>
                <tr>
                  <th style="width: 40px;">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
                  </th>
                  <th>Product Name</th>
                  <th>Display Name</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Files</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productsTableBody">
                <!-- Products will be loaded here -->
              </tbody>
            </table>
          <? } ?>
        </div>
      </div>
      
      <!-- Analytics Tab -->
      <div id="analyticsTab" class="tab-content">
        <div class="actions">
          <button class="btn btn-secondary" onclick="loadAnalytics()">
            üîÑ Refresh Analytics
          </button>
          <button class="btn btn-secondary" onclick="setupAnalyticsSheet()">
            üìä Setup Analytics Sheet
          </button>
          <button class="btn btn-secondary" onclick="exportAnalytics()">
            üì• Export to CSV
          </button>
        </div>
        
        <div id="analyticsContainer">
          <div id="analyticsSummary">
            <!-- Summary cards will be loaded here -->
          </div>
 
        </div>
        
        <div id="productsContainer">
          <? if (products.length === 0) { ?>
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
              </svg>
              <h2>No Products Yet</h2>
              <p>Click "Add New Product" to get started</p>
            </div>
          <? } else { ?>
            <table class="products-table">
              <thead>
                <tr>
                  <th>Product Name</th>
                  <th>Display Name</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Files</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productsTableBody">
                <!-- Products will be loaded here -->
              </tbody>
            </table>
          <? } ?>
        </div>
      </div>
      
      <!-- Analytics Tab -->
      <div id="analyticsTab" class="tab-content">
        <div class="actions">
          <button class="btn btn-secondary" onclick="loadAnalytics()">
            üîÑ Refresh Analytics
          </button>
          <button class="btn btn-secondary" onclick="setupAnalyticsSheet()">
            üìä Setup Analytics Sheet
          </button>
          <button class="btn btn-secondary" onclick="exportAnalytics()">
            üì• Export to CSV
          </button>
        </div>
        
        <div id="analyticsContainer">
          <div id="analyticsSummary">
            <!-- Summary cards will be loaded here -->
          </div>
          
          <h3 style="margin-top: 30px; margin-bottom: 15px;">Product Access Statistics</h3>
          <div id="analyticsDetails">
            <!-- Detailed analytics table will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add/Edit Product Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Product</h2>
      </div>
      
      <form id="productForm" onsubmit="saveProduct(event)">
        <div class="form-group">
          <label for="productName">Product Name (Internal ID)*</label>
          <input type="text" id="productName" required 
                 pattern="[A-Za-z0-9_-]+" 
                 title="Only letters, numbers, hyphens and underscores">
          <small>Used in URLs. Example: EventPlanning</small>
        </div>
        
        <div class="form-group">
          <label for="displayName">Display Name*</label>
          <input type="text" id="displayName" required>
          <small>User-facing name shown on landing page</small>
        </div>
        
        <div class="form-group">
          <label for="folderId">Google Drive Folder*</label>
          <div class="folder-picker">
              <input type="text" id="folderId" required placeholder="Click 'Browse File' to select a template file">
              <button type="button" class="btn btn-secondary" onclick="openDrivePicker()">
                ÔøΩ Browse File
              </button>
            </div>
          <small style="color: #666; display: block; margin-top: 6px;">
            Select any template file from your Drive. We'll automatically use its parent folder to find all versions.
          </small>
          <div id="folderInfo" class="folder-info"></div>
        </div>
        
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" placeholder="Brief description for landing page"></textarea>
        </div>
        
        <div class="form-group">
          <label for="category">Category</label>
          <input type="text" id="category" placeholder="e.g., Event Planning, Communication, Finance">
          <small>Group products by category on the landing page</small>
        </div>
        
        <div class="form-group">
          <label for="tags">Tags (comma-separated)</label>
          <input type="text" id="tags" placeholder="e.g., planning, calendar, scheduling">
          <small>Add tags for easier searching and filtering</small>
        </div>
        
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="enabled" checked>
            <label for="enabled">Enable this product</label>
          </div>
        </div>
        
        <div class="actions">
          <button type="submit" class="btn btn-primary">
            üíæ Save Product
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">
            ‚ùå Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- CSV Import Preview Modal -->
  <div id="importPreviewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Import Preview</h2>
      </div>
      
      <div id="importPreviewContent">
        <!-- Preview content will be loaded here -->
      </div>
      
      <div class="actions">
        <button class="btn btn-primary" id="confirmImportBtn" onclick="confirmImport()">
          ‚úÖ Confirm Import
        </button>
        <button class="btn btn-secondary" onclick="closeImportPreview()">
          ‚ùå Cancel
        </button>
      </div>
    </div>
  </div>
  </div>

  <script>
    // State
    let products = <?!= JSON.stringify(products) ?>;
    let pickerApiLoaded = false;
    let oauthToken = null;
    let developerKey = null;
    let pickerAppId = null;
    let editingProduct = null;
    let selectedProducts = new Set();
    let pendingImportData = null;

    // Verbose UI logging helper
    const UI_DEBUG = true; // set to false to disable verbose client logging
    function uiLog(...args) {
      if (!UI_DEBUG) return;
      try { console.log(new Date().toISOString(), ...args); } catch (e) {}
    }

    // Helper to wrap google.script.run calls with consistent logging and timing
    function runServerCall(functionName, args, label, handlers) {
      args = args || [];
      label = label || functionName;
      handlers = handlers || {};
      const start = Date.now();
      uiLog(`[${label}] -> request`, { functionName, args });

      const caller = google.script.run
        .withSuccessHandler(function(result) {
          const duration = Date.now() - start;
          uiLog(`[${label}] <- success`, { durationMs: duration, result });
          if (handlers.success) try { handlers.success(result); } catch (e) { uiLog(`[${label}] success handler error`, e); }
        })
        .withFailureHandler(function(error) {
          const duration = Date.now() - start;
          uiLog(`[${label}] <- failure`, { durationMs: duration, error });
          if (handlers.failure) try { handlers.failure(error); } catch (e) { uiLog(`[${label}] failure handler error`, e); }
        });

      // Invoke the named server function on the chained caller
      try {
        caller[functionName].apply(caller, args);
      } catch (err) {
        uiLog(`[${label}] call error`, err);
        if (handlers.failure) handlers.failure(err);
      }
    }
    
    // Toast notification system
    const toastQueue = [];
    let toastIdCounter = 0;
    
    function showToast(message, type, duration, title) {
      type = type || 'info';
      duration = duration !== undefined ? duration : 5000;
      
      const toastId = 'toast-' + (toastIdCounter++);
      const container = document.getElementById('toastContainer');
      
      const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
      const titles = {
        success: title || 'Success',
        error: title || 'Error',
        warning: title || 'Warning',
        info: title || 'Info'
      };
      
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.id = toastId;
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-content">
          <div class="toast-title">${titles[type]}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="closeToast('${toastId}')" aria-label="Close">√ó</button>
      `;
      
      container.appendChild(toast);
      
      if (duration > 0) {
        setTimeout(function() { closeToast(toastId); }, duration);
      }
      
      return toastId;
    }
    
    function closeToast(toastId) {
      const toast = document.getElementById(toastId);
      if (!toast) return;
      
      toast.classList.add('hiding');
      setTimeout(function() {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 300);
    }
    
    function showLoading(show, text) {
      const overlay = document.getElementById('loadingOverlay');
      const textEl = document.getElementById('loadingText');
      
      if (show) {
        if (text) textEl.textContent = text;
        overlay.classList.add('active');
      } else {
        overlay.classList.remove('active');
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadProducts();
      loadGooglePicker();

      // If we're embedded in the Apps Script editor iframe, show an instruction banner
      try {
        if (window.top !== window) {
          const b = document.getElementById('editorBanner');
          if (b) {
            b.style.display = 'block';
            const btn = document.getElementById('openTopBtn');
            if (btn) btn.addEventListener('click', function() {
              // Open the current iframe content at top-level
              try { window.top.location.href = window.location.href; } catch (e) { window.open(window.location.href, '_blank'); }
            });
          }
        }
      } catch (e) {
        // ignore
      }
    });
    
    // Load products into table
    function loadProducts() {
      const tbody = document.getElementById('productsTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = products.map(product => `
        <tr>
 
          <td>
            <input type="checkbox" class="product-checkbox" data-product="${product.name}" 
                   onchange="updateSelection('${product.name}', this.checked)">
          </td>
 
 
          <td data-label="Product Name"><strong>${product.name}</strong></td>
          <td data-label="Display Name">${product.displayName}</td>
          <td data-label="Category"><span style="padding: 4px 8px; background: #667eea; color: white; border-radius: 4px; font-size: 0.85em;">${product.category || 'Uncategorized'}</span></td>
          <td data-label="Status">
            <span class="status-badge ${product.enabled ? 'status-enabled' : 'status-disabled'}">
              ${product.enabled ? 'Enabled' : 'Disabled'}
            </span>
          </td>
          <td data-label="Files">
            <a href="https://drive.google.com/drive/folders/${product.folderId}" target="_blank">
              View Folder ‚Üí
            </a>
          </td>
          <td data-label="Actions">
            <button class="btn btn-secondary" onclick='editProduct(${JSON.stringify(product)})' style="padding: 6px 12px; font-size: 0.9em;">
              ‚úèÔ∏è Edit
            </button>
            <button class="btn btn-secondary" onclick="copyProductLink('${product.name}')" style="padding: 6px 12px; font-size: 0.9em; margin-left:6px;">
              üîó Copy Link
            </button>
            <button class="btn btn-secondary" onclick="toggleProduct('${product.name}')" style="padding: 6px 12px; font-size: 0.9em;">
              ${product.enabled ? '‚è∏Ô∏è Disable' : '‚ñ∂Ô∏è Enable'}
            </button>
            <button class="btn btn-danger" onclick="deleteProduct_confirm('${product.name}')" style="padding: 6px 12px; font-size: 0.9em;">
              üóëÔ∏è
            </button>
          </td>
        </tr>
      `).join('');
      
      // Update selection state
      updateSelectionUI();
    }
    
    // Modal functions
    function openAddProductModal() {
      editingProduct = null;
      document.getElementById('modalTitle').textContent = 'Add New Product';
      document.getElementById('productForm').reset();
      document.getElementById('productName').disabled = false;
      document.getElementById('productModal').classList.add('active');
    }
    
    function editProduct(product) {
      editingProduct = product.name;
      document.getElementById('modalTitle').textContent = 'Edit Product';
      document.getElementById('productName').value = product.name;
      document.getElementById('productName').disabled = true;
      document.getElementById('displayName').value = product.displayName;
      document.getElementById('folderId').value = product.folderId;
      document.getElementById('description').value = product.description || '';
      document.getElementById('category').value = product.category || '';
      
      // Format tags for display: convert array to comma-separated string
      let tagsValue = '';
      if (product.tags) {
        tagsValue = Array.isArray(product.tags) ? product.tags.join(', ') : product.tags;
      }
      document.getElementById('tags').value = tagsValue;
      
      document.getElementById('enabled').checked = product.enabled;
      document.getElementById('productModal').classList.add('active');
      
      // Load folder info
      validateFolder(product.folderId);
    }
    
    function closeModal() {
      document.getElementById('productModal').classList.remove('active');
    }
    
    // Save product
    function saveProduct(event) {
      event.preventDefault();
      
      // Parse tags from comma-separated input
      const tagsInput = document.getElementById('tags').value;
      const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
      
      const productData = {
        name: document.getElementById('productName').value,
        displayName: document.getElementById('displayName').value,
        folderId: document.getElementById('folderId').value,
        description: document.getElementById('description').value,
        category: document.getElementById('category').value || 'Uncategorized',
        tags: tags,
        enabled: document.getElementById('enabled').checked
      };
      
      showLoading(true, editingProduct ? 'Updating product...' : 'Adding product...');
      
      const functionName = editingProduct ? 'updateProduct' : 'addProduct';
      const args = editingProduct ? [editingProduct, productData] : [productData];
      
      runServerCall(functionName, args, 'saveProduct', {
        success: function(result) {
          showLoading(false);
          
          if (result.success) {
            showToast(result.message || 'Product saved successfully', 'success');
            closeModal();
            // Update local products array and re-render instead of full reload
            if (editingProduct) {
              // update existing
              products = products.map(function(p) {
                if (p.name === editingProduct) {
                  return Object.assign({}, p, productData);
                }
                return p;
              });
            } else {
              // add new
              products.push(productData);
            }
            loadProducts();
          } else {
            showToast(result.error, 'error', 7000);
          }
        },
        failure: function(error) {
          showLoading(false);
          const errorMsg = error && error.message ? error.message : String(error);
          showToast('Failed to save product: ' + errorMsg, 'error', 7000);
        }
      });
    }
    
    // Toggle product
    function toggleProduct(productName) {
      showLoading(true, 'Updating product status...');
      
      runServerCall('toggleProductEnabled', [productName], 'toggleProduct', {
        success: function(result) {
          showLoading(false);
          
          if (result.success) {
            showToast(result.message || 'Product status updated', 'success');
            // Update local products array and re-render without a full reload
            products = products.map(function(p) {
              if (p.name === productName) {
                p.enabled = result.enabled;
              }
              return p;
            });
            loadProducts();
          } else {
            showToast(result.error, 'error', 7000);
          }
        },
        failure: function(error) {
          showLoading(false);
          const errorMsg = error && error.message ? error.message : String(error);
          showToast('Failed to update product: ' + errorMsg, 'error', 7000);
        }
      });
    }
    
    // Delete product
    function deleteProduct_confirm(productName) {
      if (!confirm(`Are you sure you want to delete "${productName}"?`)) {
        return;
      }
      
      runServerCall('deleteProduct', [productName], 'deleteProduct', {
        success: function(result) {
          if (result.success) {
            // Remove from local products array and re-render
            products = products.filter(function(p) { return p.name !== productName; });
            loadProducts();
            showAlert(result.message, 'success');
          } else {
            showAlert('Error: ' + result.error, 'error');
          }
        },
        failure: function(error) {
          showAlert('Error: ' + (error && error.message ? error.message : error), 'error');
        }
      });
    }
    
    // Refresh products
    function refreshProducts() {
      // Force reload to the admin page to avoid preview/param issues
      try {
        const base = detectBaseFromLocation();
        window.location.href = (base.endsWith('/') ? base : base + '') + '?admin=true';
      } catch (e) {
        window.location.reload();
      }
    }
    
    // Clear cache
    function clearCache() {
      runServerCall('clearConfigCache', [], 'clearCache', {
        success: function() { showAlert('Cache cleared successfully', 'success'); },
        failure: function(error) { showAlert('Error: ' + (error && error.message ? error.message : error), 'error'); }
      });
    }
    
    // Validate folder
    function validateFolder(folderId) {
      const folderInfo = document.getElementById('folderInfo');
      folderInfo.innerHTML = '<div class="loading"></div> Checking folder...';
      folderInfo.classList.add('active');
      
      runServerCall('getFolderDetails', [folderId], 'validateFolder', {
        success: function(result) {
          if (result.success) {
            folderInfo.innerHTML = `
              ‚úÖ <strong>${result.name}</strong><br>
              üìä Contains ${result.fileCount} Google Sheets file(s)
            `;
          } else {
            folderInfo.innerHTML = `‚ùå ${result.error}`;
          }
        },
        failure: function(error) {
          folderInfo.innerHTML = `‚ùå ${error && error.message ? error.message : error}`;
        }
      });
    }
    
    // Google Drive Picker
    function loadGooglePicker() {
      gapi.load('picker', function() {
        pickerApiLoaded = true;
      });
      
      runServerCall('getOAuthToken', [], 'getOAuthToken', {
        success: function(token) { oauthToken = token; uiLog('oauthToken retrieved', { hasToken: !!token }); },
        failure: function(error) { uiLog('getOAuthToken failed', error); }
      });

      // Fetch the Google Picker API key from Script Properties
      runServerCall('getPickerApiKey', [], 'getPickerApiKey', {
        success: function(key) {
          developerKey = key;
          if (!developerKey) {
            console.warn('Google Picker API key not set. Add PICKER_API_KEY in Script Properties.');
          }
          uiLog('Picker key fetched', { keyPrefix: developerKey ? developerKey.substring(0,6) : null, keyLength: developerKey ? developerKey.length : 0 });
        },
        failure: function(error) { uiLog('getPickerApiKey failed', error); }
      });

      // Fetch optional Picker App ID (numeric GCP project number)
      runServerCall('getPickerAppId', [], 'getPickerAppId', {
        success: function(id) { pickerAppId = id; if (pickerAppId) uiLog('Picker App ID:', pickerAppId); },
        failure: function(error) { uiLog('getPickerAppId failed', error); }
      });
    }
    
/**
 * Opens the Google Picker to select a template FILE.
 * We'll extract the parent folder server-side for reliable folder detection.
 */
function openDrivePicker() {
  uiLog('openDrivePicker called', { pickerApiLoaded: pickerApiLoaded, hasToken: !!oauthToken });
  if (!pickerApiLoaded || !oauthToken) {
    alert('Drive Picker is loading... please try again in a moment.');
    return;
  }

  if (!developerKey) {
    alert('Google Picker is not configured. Ask the admin to set PICKER_API_KEY in Script Properties (Apps Script ‚Üí Project Settings).');
    return;
  }
  
  const origin = (google && google.script && google.script.host && google.script.host.origin)
    ? google.script.host.origin
    : window.location.origin;

  console.log('Picker diagnostics on open:', {
    pickerApiLoaded,
    hasToken: !!oauthToken,
    origin
  });

  // Create standard views for file selection (most reliable approach)
  // No MIME type filter - allow any file type (templates can be Sheets, Docs, Slides, PDFs, etc.)
  
  // Recent view
  const recentView = new google.picker.DocsView(google.picker.ViewId.RECENTLY_PICKED);

  // My Drive with tree navigation (no setIncludeFolders - that makes it flat!)
  const driveView = new google.picker.DocsView(google.picker.ViewId.DOCS);

  // Shared Drives view
  const sharedDriveView = new google.picker.DocsView(google.picker.ViewId.DOCS)
    .setEnableDrives(true);

  // Build the Picker
  const builder = new google.picker.PickerBuilder()
    .setTitle('Select a Template File')
    .setOAuthToken(oauthToken)
    .setDeveloperKey(developerKey)
    .setOrigin(origin)
    .setCallback(pickerCallback)
    .addView(recentView)
    .addView(driveView)
    .addView(sharedDriveView)
    .enableFeature(google.picker.Feature.SUPPORT_DRIVES);

  if (pickerAppId) {
    try {
      builder.setAppId(pickerAppId);
    } catch (err) {
      console.warn('Failed to set Picker App ID:', err && err.message);
    }
  }

  const picker = builder.build();
  picker.setVisible(true);
}
    
    function pickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const file = data.docs[0];
        uiLog('pickerCallback: file selected', { fileId: file.id, fileName: file.name });
        
        // Show loading state
        const folderInfo = document.getElementById('folderInfo');
        folderInfo.innerHTML = '<div class="loading"></div> Getting parent folder...';
        folderInfo.classList.add('active');
        
        // Call server to get parent folder from file ID
        runServerCall('getParentFolderFromFile', [file.id], 'getParentFolder', {
          success: function(result) {
            if (result.success) {
              document.getElementById('folderId').value = result.folderId;
              folderInfo.innerHTML = `
                ‚úÖ <strong>${result.folderName}</strong><br>
                üìä Contains ${result.fileCount} file(s)<br>
                <small style="color: #666;">Selected from: ${file.name}</small>
              `;
            } else {
              folderInfo.innerHTML = `‚ùå ${result.error}`;
            }
          },
          failure: function(error) {
            folderInfo.innerHTML = `‚ùå ${error && error.message ? error.message : error}`;
          }
        });
      }
    }

    // Public URL helpers
    function detectBaseFromLocation() {
      try {
        const href = window.location.href;
        const execIndex = href.indexOf('/exec');
        const devIndex = href.indexOf('/dev');
        if (execIndex !== -1) return href.substring(0, execIndex) + '/exec';
        if (devIndex !== -1) return href.substring(0, devIndex) + '/dev';
        // Fallback to origin + pathname (without trailing slash)
        return (window.location.origin + window.location.pathname).replace(/\/$/, '');
      } catch (e) {
        uiLog('detectBaseFromLocation failed', e && e.message);
        return window.location.origin;
      }
    }

    function copyProductLink(productName) {
      uiLog('copyProductLink', { productName });

      runServerCall('getPublicWebAppUrl', [], 'getPublicWebAppUrl', {
        success: function(override) {
          const base = override && override.length ? override : detectBaseFromLocation();
          // Ensure no duplicate slashes
          let url = base;
          // If base already ends with /exec or /dev, avoid adding another slash
          if (!url.endsWith('/exec') && !url.endsWith('/dev') && !url.endsWith('/')) url += '/';
          url += '?product=' + encodeURIComponent(productName);
          copyToClipboard(url).then(function() {
            showAlert('Product link copied to clipboard', 'success');
            uiLog('copyProductLink success', { url });
          }).catch(function(err) {
            // Fallback: show prompt
            const fallback = prompt('Copy the product link below', url);
            uiLog('copyProductLink fallback prompt', { result: fallback });
          });
        },
        failure: function(err) {
          uiLog('getPublicWebAppUrl failed', err);
          const base = detectBaseFromLocation();
          let url = base;
          if (!url.endsWith('/exec') && !url.endsWith('/dev') && !url.endsWith('/')) url += '/';
          url += '?product=' + encodeURIComponent(productName);
          copyToClipboard(url).then(function() {
            showAlert('Product link copied to clipboard', 'success');
          }).catch(function() {
            prompt('Copy the product link below', url);
          });
        }
      });
    }

    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise(function(resolve, reject) {
        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          resolve();
        } catch (e) {
          reject(e);
        }
      });
    }

    function configurePublicUrl() {
      // Ask admin for an override URL (or clear it)
      runServerCall('getPublicWebAppUrl', [], 'getPublicWebAppUrl', {
        success: function(current) {
          const hint = current && current.length ? current : detectBaseFromLocation();
          const val = prompt('Set the canonical public web app URL (leave blank to clear):', hint);
          if (val === null) return; // cancelled
          // Validate the provided URL (best-effort) before saving
          runServerCall('validatePublicWebAppUrl', [val || ''], 'validatePublicWebAppUrl', {
            success: function(validation) {
              if (validation && validation.success) {
                // Verified redirect to Apps Script ‚Äî save it
                runServerCall('setPublicWebAppUrl', [val || ''], 'setPublicWebAppUrl', {
                  success: function(res) { if (res && res.success) showAlert('Public URL saved and verified', 'success'); else showAlert('Saved but could not verify: ' + (res && res.error ? res.error : ''), 'error'); },
                  failure: function(err) { showAlert('Error saving public URL: ' + (err && err.message ? err.message : err), 'error'); }
                });
              } else {
                // Show warning and let admin choose to save anyway
                const msg = (validation && validation.warning) ? validation.warning : (validation && validation.error ? validation.error : 'Validation failed');
                if (confirm(msg + '\n\nSave this URL anyway?')) {
                  runServerCall('setPublicWebAppUrl', [val || ''], 'setPublicWebAppUrl', {
                    success: function(res) { if (res && res.success) showAlert('Public URL saved', 'success'); else showAlert('Error saving public URL: ' + (res && res.error ? res.error : ''), 'error'); },
                    failure: function(err) { showAlert('Error saving public URL: ' + (err && err.message ? err.message : err), 'error'); }
                  });
                } else {
                  showAlert('Public URL not saved', 'info');
                }
              }
            },
            failure: function(err) { showAlert('Validation error: ' + (err && err.message ? err.message : err), 'error'); }
          });
        },
        failure: function(err) {
          uiLog('getPublicWebAppUrl failed', err);
          const val = prompt('Set the canonical public web app URL (leave blank to clear):', detectBaseFromLocation());
          if (val === null) return;
          // Validate when fallback path used
          runServerCall('validatePublicWebAppUrl', [val || ''], 'validatePublicWebAppUrl', {
            success: function(validation) {
              if (validation && validation.success) {
                runServerCall('setPublicWebAppUrl', [val || ''], 'setPublicWebAppUrl', { success: function(res) { if (res && res.success) showAlert('Public URL saved and verified', 'success'); else showAlert('Saved but could not verify', 'error'); }, failure: function(err) { showAlert('Error saving public URL: ' + (err && err.message ? err.message : err), 'error'); } });
              } else {
                const msg = (validation && validation.warning) ? validation.warning : (validation && validation.error ? validation.error : 'Validation failed');
                if (confirm(msg + '\n\nSave this URL anyway?')) {
                  runServerCall('setPublicWebAppUrl', [val || ''], 'setPublicWebAppUrl', { success: function(res) { if (res && res.success) showAlert('Public URL saved', 'success'); else showAlert('Error saving public URL', 'error'); }, failure: function(err) { showAlert('Error: ' + (err && err.message ? err.message : err), 'error'); } });
                } else { showAlert('Public URL not saved', 'info'); }
              }
            },
            failure: function(err) { showAlert('Validation error: ' + (err && err.message ? err.message : err), 'error'); }
          });
        }
      });
    }

    
    // ========================================================================
    // ANALYTICS FUNCTIONS
    // ========================================================================
    
    /**
     * Switches between tabs in the admin panel
     */
    function switchTab(tabName, clickedElement) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      if (clickedElement) {
        clickedElement.classList.add('active');
      }
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      if (tabName === 'products') {
        document.getElementById('productsTab').classList.add('active');
      } else if (tabName === 'analytics') {
        document.getElementById('analyticsTab').classList.add('active');
        // Load analytics when tab is opened
        loadAnalytics();
      }
    }
    
    /**
     * Loads analytics data and displays it
     */
    function loadAnalytics() {
      showAlert('Loading analytics...', 'info');
      
      runServerCall('getAnalyticsForAdmin', [], 'getAnalytics', {
        success: function(data) {
          displayAnalyticsSummary(data);
          displayAnalyticsDetails(data);
          showAlert('Analytics loaded', 'success');
        },
        failure: function(error) {
          showAlert('Error loading analytics: ' + (error && error.message ? error.message : error), 'error');
        }
      });
    }
    
    /**
     * Displays analytics summary cards
     */
    function displayAnalyticsSummary(data) {
      const summaryContainer = document.getElementById('analyticsSummary');
      
      if (data.error) {
        summaryContainer.innerHTML = `
          <div class="alert alert-error">
            Error loading analytics: ${data.error}
          </div>
        `;
        return;
      }
      
      const totalProducts = data.products ? data.products.length : 0;
      const totalAccesses = data.totalAccesses || 0;
      const enabledProducts = data.products ? data.products.filter(p => p.enabled).length : 0;
      
      summaryContainer.innerHTML = `
        <div class="analytics-grid">
          <div class="analytics-card">
            <h3>Total Products</h3>
            <div class="value">${totalProducts}</div>
          </div>
          <div class="analytics-card">
            <h3>Total Accesses</h3>
            <div class="value">${totalAccesses}</div>
          </div>
          <div class="analytics-card">
            <h3>Active Products</h3>
            <div class="value">${enabledProducts}</div>
          </div>
          <div class="analytics-card">
            <h3>Last Updated</h3>
            <div class="value" style="font-size: 1.2em;">${data.generatedAt ? new Date(data.generatedAt).toLocaleTimeString() : new Date().toLocaleTimeString()}</div>
          </div>
        </div>
      `;
    }
    
    /**
     * Displays detailed analytics table
     */
    function displayAnalyticsDetails(data) {
      const detailsContainer = document.getElementById('analyticsDetails');
      
      if (!data.products || data.products.length === 0) {
        detailsContainer.innerHTML = `
          <div class="empty-state">
            <p>No analytics data available yet. Analytics will be collected as users access templates.</p>
          </div>
        `;
        return;
      }
      
      // Calculate max accesses for progress bar scaling
      const maxAccesses = Math.max(...data.products.map(p => p.totalAccesses), 1);
      
      const rows = data.products.map(product => {
        const percentage = (product.totalAccesses / maxAccesses * 100).toFixed(1);
        const latestPercent = product.totalAccesses > 0 
          ? (product.latestRequests / product.totalAccesses * 100).toFixed(0)
          : 0;
        const specificPercent = product.totalAccesses > 0 
          ? (product.specificRequests / product.totalAccesses * 100).toFixed(0)
          : 0;
        
        return `
          <tr>
            
            <td data-label="Product"><strong>${product.displayName}</strong></td>
            <td data-label="Total Accesses">${product.totalAccesses}</td>
            <td data-label="Latest Version">
              ${product.latestRequests} (${latestPercent}%)
            </td>
            <td data-label="Specific Version">
              ${product.specificRequests} (${specificPercent}%)
            </td>
            <td data-label="Popularity">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      detailsContainer.innerHTML = `
        <table class="analytics-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Total Accesses</th>
              <th>Latest Version</th>
              <th>Specific Version</th>
              <th>Popularity</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }
    
    /**
     * Sets up analytics sheet
     */
    function setupAnalyticsSheet() {
      if (!confirm('This will create a new Google Sheet for detailed analytics logging. Continue?')) {
        return;
      }
      
      showAlert('Creating analytics sheet...', 'info');
      
      runServerCall('adminCreateAnalyticsSheet', [], 'setupAnalytics', {
        success: function(result) {
          if (result.success) {
            showAlert('Analytics sheet created successfully! You can view it at: ' + result.sheetUrl, 'success');
          } else {
            showAlert('Error: ' + result.error, 'error');
          }
        },
        failure: function(error) {
          showAlert('Error: ' + (error && error.message ? error.message : error), 'error');
        }
      });
    }
    
    /**
     * Exports analytics to CSV
     */
    function exportAnalytics() {
      showAlert('Exporting analytics...', 'info');
      
      runServerCall('adminExportAnalytics', [{}], 'exportAnalytics', {
        success: function(csvData) {
          // Create download link
          const blob = new Blob([csvData], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'analytics-' + new Date().toISOString().split('T')[0] + '.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          
          showAlert('Analytics exported successfully', 'success');
        },
        failure: function(error) {
          showAlert('Error exporting analytics: ' + (error && error.message ? error.message : error), 'error');
        }
      });
      }
    
      // ========================================================================
      // BULK OPERATIONS
      // ========================================================================
    
    function updateSelection(productName, checked) {
      if (checked) {
        selectedProducts.add(productName);
      } else {
        selectedProducts.delete(productName);
      }
      updateSelectionUI();
    }
    
    function toggleSelectAll(checked) {
      selectedProducts.clear();
      if (checked) {
        products.forEach(p => selectedProducts.add(p.name));
      }
      
      // Update checkboxes
      document.querySelectorAll('.product-checkbox').forEach(cb => {
        cb.checked = checked;
      });
      
      updateSelectionUI();
    }
    
    function updateSelectionUI() {
      const count = selectedProducts.size;
      const bar = document.getElementById('bulkActionsBar');
      const countSpan = document.getElementById('selectedCount');
      
      if (count > 0) {
        bar.classList.add('active');
        countSpan.textContent = count + ' product' + (count > 1 ? 's' : '') + ' selected';
      } else {
        bar.classList.remove('active');
      }
      
      // Update "select all" checkbox
      const selectAll = document.getElementById('selectAll');
      if (selectAll) {
        selectAll.checked = count === products.length && count > 0;
      }
    }
    
    function clearSelection() {
      selectedProducts.clear();
      document.querySelectorAll('.product-checkbox').forEach(cb => {
        cb.checked = false;
      });
      updateSelectionUI();
    }
    
    function executeBulkAction() {
      const action = document.getElementById('bulkActionSelect').value;
      
      if (!action) {
        alert('Please select an action');
        return;
      }
      
      if (selectedProducts.size === 0) {
        alert('No products selected');
        return;
      }
      
      const productNames = Array.from(selectedProducts);
      
      if (action === 'delete') {
        if (!confirm(`Are you sure you want to delete ${productNames.length} product(s)?\n\nThis action cannot be undone.`)) {
          return;
        }
        
        showAlert('Deleting products...', 'info');
        
        runServerCall('bulkDeleteProducts', [productNames], 'bulkDelete', {
          success: function(result) {
            if (result.success) {
              showAlert(result.message, 'success');
              
              // Remove deleted products from local array
              products = products.filter(p => !productNames.includes(p.name));
              
              // Clear selection
              clearSelection();
              
              // Reload products
              loadProducts();
              
              if (result.errors && result.errors.length > 0) {
                console.warn('Bulk delete errors:', result.errors);
              }
            } else {
              showAlert('Error: ' + result.error, 'error');
            }
          },
          failure: function(error) {
            showAlert('Error: ' + (error && error.message ? error.message : error), 'error');
          }
        });
      } else if (action === 'enable' || action === 'disable') {
        const enabled = action === 'enable';
        showAlert(`${enabled ? 'Enabling' : 'Disabling'} products...`, 'info');
        
        runServerCall('bulkToggleProducts', [productNames, enabled], 'bulkToggle', {
          success: function(result) {
            if (result.success) {
              showAlert(result.message, 'success');
              
              // Update local products array
              products = products.map(p => {
                if (productNames.includes(p.name)) {
                  p.enabled = enabled;
                }
                return p;
              });
              
              // Clear selection
              clearSelection();
              
              // Reload products
              loadProducts();
              
              if (result.errors && result.errors.length > 0) {
                console.warn('Bulk toggle errors:', result.errors);
              }
            } else {
              showAlert('Error: ' + result.error, 'error');
            }
          },
          failure: function(error) {
            showAlert('Error: ' + (error && error.message ? error.message : error), 'error');
          }
        });
      }
    }
    
    
    // ========================================================================
    // CSV IMPORT/EXPORT
    // ========================================================================
    
    function exportToCSV() {
      showAlert('Exporting products...', 'info');
      
      runServerCall('exportProductsToCSV', [], 'exportCSV', {
        success: function(result) {
          if (result.success) {
            // Create download link
            const blob = new Blob([result.csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', result.filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('CSV exported successfully', 'success');
          } else {
            showAlert('Error exporting: ' + result.error, 'error');
          }
        },
        failure: function(error) {
          showAlert('Error: ' + (error && error.message ? error.message : error), 'error');
        }
      });
    }
    
    function downloadCSVTemplate() {
      runServerCall('generateCSVTemplate', [], 'csvTemplate', {
        success: function(result) {
          if (result.success) {
            const blob = new Blob([result.csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', result.filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('CSV template downloaded', 'success');
          } else {
            showAlert('Error: ' + result.error, 'error');
          }
        },
        failure: function(error) {
          showAlert('Error: ' + (error && error.message ? error.message : error), 'error');
        }
      });
    }
    
    function handleCSVUpload(event) {
      const file = event.target.files[0];
      
      if (!file) {
        return;
      }
      
      // Validate file extension
      if (!file.name.endsWith('.csv')) {
        alert('Please select a CSV file');
        event.target.value = '';
        return;
      }
      
      // Validate MIME type for security
      if (file.type && file.type !== 'text/csv' && file.type !== 'application/csv' && file.type !== 'text/plain') {
        alert('Invalid file type. Please select a valid CSV file.');
        event.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const csvContent = e.target.result;
        
        showAlert('Validating CSV...', 'info');
        
        runServerCall('validateCSVImport', [csvContent], 'validateCSV', {
          success: function(result) {
            if (result.success) {
              // Store for later import
              pendingImportData = csvContent;
              
              // Show preview
              showImportPreview(result);
            } else {
              showAlert('CSV validation failed: ' + result.error, 'error');
            }
          },
          failure: function(error) {
            showAlert('Error: ' + (error && error.message ? error.message : error), 'error');
          }
        });
        
        // Reset file input
        event.target.value = '';
      };
      
      reader.onerror = function() {
        alert('Error reading file');
        event.target.value = '';
      };
      
      reader.readAsText(file);
    }
    
    function showImportPreview(validation) {
      const modal = document.getElementById('importPreviewModal');
      const content = document.getElementById('importPreviewContent');
      
      let html = '<div class="summary-box">';
      html += '<h3>Import Summary</h3>';
      html += '<p><strong>Total products:</strong> ' + validation.summary.total + '</p>';
      html += '<p><strong>New products:</strong> ' + validation.summary.new + '</p>';
      html += '<p><strong>Updates:</strong> ' + validation.summary.updates + '</p>';
      html += '</div>';
      
      // Show warnings if any
      if (validation.warnings && validation.warnings.length > 0) {
        html += '<div class="warning-list">';
        html += '<h3>‚ö†Ô∏è Warnings (' + validation.warnings.length + ')</h3>';
        html += '<ul>';
        validation.warnings.forEach(function(warning) {
          html += '<li>' + warning + '</li>';
        });
        html += '</ul>';
        html += '</div>';
      }
      
      // Show product preview
      html += '<h3>Products to Import</h3>';
      html += '<table class="preview-table">';
      html += '<thead><tr><th>Action</th><th>Name</th><th>Display Name</th><th>Category</th><th>Enabled</th><th>Tags</th></tr></thead>';
      html += '<tbody>';
      
      validation.products.forEach(function(product) {
        const rowClass = product.isUpdate ? 'preview-update' : 'preview-new';
        const action = product.isUpdate ? 'üîÑ Update' : '‚ûï New';
        const tagsDisplay = product.tags && product.tags.length > 0 ? product.tags.join(', ') : '-';
        html += '<tr class="' + rowClass + '">';
        html += '<td>' + action + '</td>';
        html += '<td><strong>' + product.name + '</strong></td>';
        html += '<td>' + product.displayName + '</td>';
        html += '<td>' + (product.category || 'Uncategorized') + '</td>';
        html += '<td>' + (product.enabled ? '‚úÖ Yes' : '‚ùå No') + '</td>';
        html += '<td style="font-size: 0.85em;">' + tagsDisplay + '</td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      
      content.innerHTML = html;
      modal.classList.add('active');
    }
    
    function closeImportPreview() {
      document.getElementById('importPreviewModal').classList.remove('active');
      pendingImportData = null;
    }
    
    function confirmImport() {
      if (!pendingImportData) {
        alert('No import data available');
        return;
      }
      
      showAlert('Importing products...', 'info');
      closeImportPreview();
      
      runServerCall('importProductsFromCSV', [pendingImportData], 'importCSV', {
        success: function(result) {
          if (result.success) {
            let message = 'Import complete: ' + result.added + ' added, ' + result.updated + ' updated';
            
            if (result.errors && result.errors.length > 0) {
              message += ' (' + result.errors.length + ' errors)';
              console.warn('Import errors:', result.errors);
            }
            
            showAlert(message, 'success');
            
            // Reload products after import completes
            refreshProducts();
          } else {
            showAlert('Import failed: ' + result.error, 'error');
          }
        },
        failure: function(error) {
          showAlert('Error: ' + (error && error.message ? error.message : error), 'error');
        }
      });
      
      pendingImportData = null;
    }

    // Alert helper
    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `
        <div class="alert alert-${type === 'error' ? 'error' : 'success'}">
          ${message}
        </div>
      `;
      
      setTimeout(function() {
        container.innerHTML = '';
      }, 5000);
    }
  </script>

</body>
</html>
